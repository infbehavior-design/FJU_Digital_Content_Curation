---
import "../styles/global.css";

const footprintImgs = import.meta.glob(
  "/src/assets/Footprint/*.{jpg,jpeg,png,webp}",
  { eager: true }
);

function getPreviewSrc(imgPath: string) {
  if (!imgPath) return "";

  const filename = imgPath.split("/").pop();
  const key = `/src/assets/Footprint/${filename}`;

  const mod: any = footprintImgs[key];
  const d = mod?.default;

  // 1) Vite url: string
  if (typeof d === "string") return d;

  // 2) Astro ImageMetadata: { src, width, height, ... }
  if (d && typeof d === "object" && typeof d.src === "string") return d.src;

  return "";
}

const cards = [
  {
    title: "å¥ å®šåŸºç¤",
    date: "114.09 ~ 114.09",
    imageLabel: "Image",
    description:
      "èª²ç¨‹åˆæœŸï¼Œè€å¸«å¸¶é ˜æˆ‘å€‘èªè­˜è³‡è¨Šè¡Œç‚ºç ”ç©¶çš„ä¸åŒç¯„ç–‡ï¼Œèªªæ˜è³‡è¨Šä½¿ç”¨è€…åœ¨å„ç¨®æƒ…å¢ƒä¸‹çš„è¡Œç‚ºç‰¹æ€§ï¼Œä¸¦æ¯”è¼ƒè³‡è¨Šä½¿ç”¨çš„é€šç”¨æ¨¡å¼èˆ‡å°ˆæ¥­äººå£«æ¨¡å¼ï¼Œå”åŠ©æˆ‘å€‘å»ºç«‹åˆ†æè³‡è¨Šè¡Œç‚ºçš„ç†è«–åŸºç¤ï¼Œç‚ºå¾ŒçºŒå¯¦ä½œå¥ å®šç†è§£æ¡†æ¶ã€‚",
    // TODOï¼šæŠŠä¸‹é¢è·¯å¾‘æ›æˆä½ è‡ªå·±çš„åœ–ç‰‡
    images: [
      "src/assets/Footprint/Basis-1.jpg",
      "src/assets/Footprint/Basis-2.jpg",
    ],
  },
  {
    title: "æ•™è‚²è¨“ç·´",
    date: "114.09 ~ 114.09",
    imageLabel: "Image",
    description:
      "èª²ç¨‹ä¸­é‚€è«‹è¼”å¤§æ–°èå‚³æ’­ç³»é™³é †å­æ•™æˆï¼Œåˆ†äº«æ–°èå ±å°èˆ‡è¨ªè«‡çš„å¯¦å‹™ç¶“é©—ï¼Œèªªæ˜æ¡è¨ªå·¥ä½œçš„æ ¸å¿ƒåƒ¹å€¼èˆ‡æŠ€å·§ï¼Œä¸¦é€éå¯¦éš›æ¡ˆä¾‹åˆ†æï¼Œè®“æˆ‘å€‘ç†è§£å¦‚ä½•æå•ã€å‚¾è½èˆ‡è¿½å•ï¼Œç‚ºå¾ŒçºŒæ¡è¨ªä½œæ¥­åšå¥½æº–å‚™ã€‚",
    images: [
      "src/assets/Footprint/training-1.jpg",
      "src/assets/Footprint/training-2.jpg",
    ],
  },
  {
    title: "å¯¦åœ°åƒè¨ª",
    date: "114.09 ~ 114.10",
    imageLabel: "Image",
    description:
      "è€å¸«å¸¶é ˜æˆ‘å€‘å‰å¾€åŸ¹æ¨‚å„‚é€²è¡Œå¯¦åœ°åƒè¨ªï¼Œäº†è§£å’–å•¡å¾ç¨®æ¤ã€é¸è±†ã€çƒ˜ç„™åˆ°ç”Ÿç”¢çš„å®Œæ•´æµç¨‹ï¼Œä¸¦çµåˆæ²–ç…®å’–å•¡çš„å¯¦éš›æ“ä½œï¼Œé€éè¦–è¦ºã€è½è¦ºèˆ‡å‘³è¦ºç­‰å¤šé‡æ„Ÿå®˜é«”é©—ï¼ŒåŠ æ·±æˆ‘å€‘å°å’–å•¡çŸ¥è­˜èˆ‡è³‡è¨Šå‚³éæ­·ç¨‹çš„ç†è§£ã€‚",
    images: [
      "src/assets/Footprint/Visit-1.jpg",
      "src/assets/Footprint/Visit-2.jpg",
      "src/assets/Footprint/Visit-3.jpg",
      "src/assets/Footprint/Visit-4.jpg",
    ],
  },
  {
    title: "äº‹å‰æº–å‚™",
    date: "114.10 ~ 114.11",
    imageLabel: "Image",
    description:
      "åœ¨å®Œæˆåƒè¨ªå¾Œï¼Œè€å¸«å›åˆ°èª²å ‚ä¸­ä»‹ç´¹ Berry-pickingã€Sense-makingã€Wilson èˆ‡ Leckie ç­‰è³‡è¨Šè¡Œç‚ºç†è«–ï¼Œå”åŠ©æˆ‘å€‘å°‡å¯¦åœ°è§€å¯Ÿèˆ‡ç†è«–é€£çµï¼Œé€²ä¸€æ­¥ç†è§£è³‡è¨Šéœ€æ±‚å½¢æˆã€æœå°‹èˆ‡ä½¿ç”¨çš„éç¨‹ï¼Œä½œç‚ºå¾ŒçºŒæ¡è¨ªèˆ‡åˆ†æçš„é‡è¦ä¾æ“šã€‚",
    images: [
      "src/assets/Footprint/prepare-1.jpg",
      "src/assets/Footprint/prepare-2.jpg",
    ],
  },
  {
    title: "æ¡è¨ªä½œæ¥­",
    date: "114.11.12",
    imageLabel: "Image",
    description:
      "æˆ‘å€‘å†æ¬¡å‰å¾€åŸ¹æ¨‚å„‚ï¼Œé‡å°åƒè¨ªå¾Œç”¢ç”Ÿçš„ç–‘å•èˆ‡ç ”ç©¶æ–¹å‘ï¼Œè¨ªè«‡å…©ä½å’–å•¡å¸«ï¼Œæ·±å…¥äº†è§£å…¶å°ˆæ¥­ç¶“é©—èˆ‡è³‡è¨Šä½¿ç”¨æ–¹å¼ï¼Œä¸¦é€éçµ„å…§åˆ†å·¥åˆä½œï¼Œå„å¸å…¶è·ï¼Œå®Œæˆæœ¬æ¬¡æ¡è¨ªèˆ‡è³‡æ–™è’é›†ä»»å‹™ã€‚",
    images: [
      "src/assets/Footprint/Interview-1.jpg",
      "src/assets/Footprint/Interview-2.jpg",
      "src/assets/Footprint/Interview-3.jpg",
      "src/assets/Footprint/Interview-4.jpg",
    ],
  },
  {
    title: "å¹•å¾Œé»æ»´",
    date: "114.11 ~ 114.12",
    imageLabel: "Image",
    description:
      "åœ¨åƒè¨ªèˆ‡æ¡è¨ªçµæŸå¾Œï¼Œå„çµ„é–‹å§‹æŠ•å…¥æˆæœè£½ä½œï¼Œæœ‰äººè² è²¬ç¶²ç«™æ¶æ§‹èˆ‡è¦–è¦ºå‘ˆç¾ï¼Œæœ‰äººé€²è¡Œå½±ç‰‡å‰ªè¼¯èˆ‡å…§å®¹çµ±æ•´ï¼Œé€éåœ˜éšŠåˆä½œæ•´åˆä¸åŒå½¢å¼çš„è³‡è¨Šï¼Œå…±åŒå®Œæˆæˆæœç™¼è¡¨å‰çš„æº–å‚™å·¥ä½œã€‚",
    images: [
      "src/assets/Footprint/Behind-1.jpg",
      "src/assets/Footprint/Behind-2.jpg",
      "src/assets/Footprint/Behind-3.jpg",
      "src/assets/Footprint/Behind-4.jpg",
    ],
  },
];
---

<section id="footprint" class="min-h-screen flex items-center justify-center bg-[#b3734f]">
  <!-- å¯¬åº¦ = 90vwï¼Œä½†æœ€å¤§ä¸è¶…é 1280px -->
  <div class="w-[90vw] max-w-[1280px] mx-auto text-center px-4 lg:px-8">
    <!-- æ¨™é¡Œ -->
    <h2 class="text-[clamp(28px,3vw,40px)] tracking-[0.12em] text-[#fff8f0] mb-10">
      èª²ç¨‹è¶³è·¡
    </h2>

    <div class="flex items-center gap-6">
      <!-- å·¦ç®­é ­ -->
      <button
        id="timeline-prev"
        class="w-14 h-14 rounded-full border-2 border-[#f6e2c9] text-[#f6e2c9] flex items-center justify-center shrink-0 transition
               hover:bg-[#f6e2c9] hover:text-[#424729]"
        aria-label="ä¸Šä¸€å¼µ">
        â†
      </button>

      <!-- æ²å‹•å®¹å™¨ï¼šsnap-x + snap-mandatory -->
      <div
        id="timeline-scroll"
        class="relative flex-1 overflow-x-auto scroll-smooth snap-x snap-mandatory flex gap-6
        px-4 sm:px-8 lg:px-10 py-4">
        <!-- å·¦é‚Šç•™ç™½ç”¨çš„ã€Œéš±å½¢å¡ã€ -->
        <div class="shrink-0 w-[10vw] sm:w-[12vw] lg:w-[14vw] snap-none"></div>

        {cards.map((card, idx) => (
          <article
            data-index={idx}
            class="timeline-snap-card shrink-0 snap-center w-[260px] md:w-[320px]">
            <div
              class="timeline-snap-inner flex flex-col items-center justify-start
                     rounded-[32px] bg-[#424729] text-[#fff8f0]
                     shadow-[0_10px_30px_rgba(0,0,0,0.25)]
                     px-6 pt-8 pb-10 transition-transform duration-300">

              <div class="text-2xl mb-2">ğŸƒ</div>

              <h3 class="text-2xl md:text-3xl tracking-[0.08em] mb-2 text-[#fff8f0]">
                {card.title}
              </h3>

              <div class="text-sm md:text-base mb-6">{card.date}</div>

              <div class="w-full aspect-[4/3] rounded-3xl overflow-hidden bg-[#e6c59b] mb-6">
                {getPreviewSrc(card.images?.[0]) ? (
                  <img
                    src={getPreviewSrc(card.images?.[0])}
                    alt={`${card.title} é è¦½`}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-xl font-semibold text-[#5b4026]">
                    {card.imageLabel}
                  </div>
                )}
              </div>
              
              <button
                type="button"
                class="timeline-more-btn mt-auto px-7 py-2 rounded-full border border-[#f6e2c9] text-[#f6e2c9] tracking-[0.12em] text-sm md:text-base transition hover:bg-[#f6e2c9] hover:text-[#424729]"
                data-index={idx}
                data-title={card.title}
                data-date={card.date}
                data-desc={card.description}
                data-images={card.images.join("|")}
              >
                äº†è§£æ›´å¤š
              </button>
            </div>
          </article>
        ))}
        <!-- å³é‚Šç•™ç™½ç”¨çš„ã€Œéš±å½¢å¡ã€ -->
        <div class="shrink-0 w-[10vw] sm:w-[12vw] lg:w-[14vw] snap-none"></div>
      </div>

      <!-- å³ç®­é ­ -->
      <button
        id="timeline-next"
        class="w-14 h-14 rounded-full border-2 border-[#f6e2c9] text-[#f6e2c9] flex items-center justify-center shrink-0 transition
               hover:bg-[#f6e2c9] hover:text-[#424729]"
        aria-label="ä¸‹ä¸€å¼µ">
        â†’
      </button>
    </div>

    <!-- ä¸‹æ–¹è£é£¾ -->
    <div class="mt-8 text-xs tracking-[0.4em] text-[#fff8f0]/80 select-none">
      Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·
    </div>
  </div>
</section>

<!-- Popup è¦–çª— -->
<div
  id="footprint-modal"
  class="fixed inset-0 z-[999] hidden bg-black/60 px-4 items-center justify-center"
>
  <div
    id="footprint-modal-card"
    class="modal-card relative w-full max-w-5xl bg-[#fdf5ee] rounded-[32px] shadow-2xl overflow-hidden flex flex-col md:flex-row gap-0"
  >
    <!-- é—œé–‰æŒ‰éˆ• -->
    <button
      id="footprint-modal-close"
      type="button"
      class="absolute right-4 top-4 w-9 h-9 rounded-full bg-black/80 text-white flex items-center justify-center text-xl leading-none hover:bg-black"
      aria-label="é—œé–‰è¦–çª—"
    >
      Ã—
    </button>

    <!-- å·¦å´ï¼šç…§ç‰‡è¼ªæ’­å€ -->
    <div class="md:w-[45%] bg-[#e6dacf] flex items-center justify-center p-5">
      <div class="relative w-full aspect-[4/5] max-h-[480px] rounded-3xl overflow-hidden bg-black/10">
        <img
          id="footprint-modal-image"
          src=""
          alt=""
          class="w-full h-full object-cover"
        />

        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button
          id="footprint-modal-image-prev"
          type="button"
          class="absolute left-3 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-black/55 text-white flex items-center justify-center text-lg hover:bg-black disabled:opacity-30 disabled:hover:bg-black/55"
          aria-label="ä¸Šä¸€å¼µç…§ç‰‡"
        >
          â†
        </button>
        <button
          id="footprint-modal-image-next"
          type="button"
          class="absolute right-3 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-black/55 text-white flex items-center justify-center text-lg hover:bg-black disabled:opacity-30 disabled:hover:bg-black/55"
          aria-label="ä¸‹ä¸€å¼µç…§ç‰‡"
        >
          â†’
        </button>

        <div
          id="footprint-modal-image-counter"
          class="absolute bottom-3 right-4 text-xs px-2 py-1 rounded-full bg-black/60 text-white"
        >
          0 / 0
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šæ–‡å­—æ•˜è¿°ï¼ˆTag å·²æ‹¿æ‰ï¼‰ -->
    <div class="md:w-[55%] p-6 md:p-9 text-left max-h-[80vh] overflow-y-auto">
      <h3
        id="footprint-modal-title"
        class="text-[clamp(22px,2.5vw,30px)] font-semibold tracking-[0.06em] mb-2 text-[#262626]"
      >
        æ¨™é¡Œ
      </h3>

      <p
        id="footprint-modal-period"
        class="text-sm font-mono tracking-[0.2em] text-[#555] mb-5"
      >
        114.09 ~ 114.09
      </p>

      <p
        id="footprint-modal-desc"
        class="text-sm md:text-base leading-relaxed text-[#333] whitespace-pre-line"
      >
        æ•˜è¿°æ–‡å­—
      </p>
    </div>
  </div>
</div>


<!-- è£œä¸€é»å…¨åŸŸ CSSï¼šæ”¾å¤§æ•ˆæœ + æ²è»¸éš±è— -->
<style is:global>
  /* ä¸­é–“é‚£å¼µ active å¡ç‰‡æ”¾å¤§ */
  .timeline-snap-card.is-active .timeline-snap-inner {
    transform: scale(1.06);
    box-shadow: 0 22px 50px rgba(0, 0, 0, 0.45);
  }

  /* éš±è—æ©«å‘æ²è»¸ï¼ˆä¿ç•™æ²å‹•åŠŸèƒ½ï¼‰ */
  #timeline-scroll::-webkit-scrollbar {
    display: none;
  }
  #timeline-scroll {
    scrollbar-width: none;
  }

  /* ===== Popup å¡ç‰‡æµ®å‡ºå‹•ç•« ===== */
  .modal-card {
    opacity: 0;
    transform: translateY(12px) scale(0.97);
  }

  @keyframes modal-pop {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.96);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .modal-pop-enter {
    animation: modal-pop 0.32s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
  }

  /* ===== Popup é—œé–‰æ·¡å‡ºå‹•ç•« ===== */
  @keyframes modal-pop-exit {
    0% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(12px) scale(0.97);
    }
  }

  .modal-pop-exit {
    animation: modal-pop-exit 0.25s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
  }
</style>


<script is:inline>
  const container = document.getElementById("timeline-scroll");
  const prevBtn = document.getElementById("timeline-prev");
  const nextBtn = document.getElementById("timeline-next");

  if (container && prevBtn && nextBtn) {
    const cards = Array.from(
      container.querySelectorAll(".timeline-snap-card"),
    );
    let activeIndex = 0;

    function clampIndex(i) {
      return Math.max(0, Math.min(cards.length - 1, i));
    }

    function updateButtons() {
      // å¾ªç’°æ¨¡å¼ â†’ æŒ‰éˆ•æ°¸é å¯ç”¨
      prevBtn.disabled = false;
      nextBtn.disabled = false;
    }

    function updateActiveClass() {
      cards.forEach((card, idx) => {
        card.classList.toggle("is-active", idx === activeIndex);
      });
    }

    function scrollToIndex(newIndex, withScroll = true) {
      activeIndex = clampIndex(newIndex);
      const target = cards[activeIndex];
      updateActiveClass();
      updateButtons();

      if (withScroll && target) {
        target.scrollIntoView({
          behavior: "smooth",
          inline: "center",
          block: "nearest",
        });
      }
    }

    prevBtn.addEventListener("click", () => {
      if (activeIndex === 0) {
        scrollToIndex(cards.length - 1); // è·³åˆ°æœ€å¾Œä¸€å¼µ
      } else {
        scrollToIndex(activeIndex - 1);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (activeIndex === cards.length - 1) {
        scrollToIndex(0); // å›åˆ°ç¬¬ä¸€å¼µ
      } else {
        scrollToIndex(activeIndex + 1);
      }
    });

    // ä½¿ç”¨è€…è‡ªè¡Œæ»‘å‹•æ™‚ï¼Œè‡ªå‹•æ›´æ–°å“ªä¸€å¼µæ˜¯ active
    let rAF = null;
    container.addEventListener("scroll", () => {
      if (rAF !== null) cancelAnimationFrame(rAF);
      rAF = requestAnimationFrame(() => {
        const containerRect = container.getBoundingClientRect();
        const containerCenter = containerRect.left + containerRect.width / 2;

        let closestIndex = activeIndex;
        let closestDist = Infinity;

        cards.forEach((card, idx) => {
          const rect = card.getBoundingClientRect();
          const cardCenter = rect.left + rect.width / 2;
          const dist = Math.abs(cardCenter - containerCenter);
          if (dist < closestDist) {
            closestDist = dist;
            closestIndex = idx;
          }
        });

        if (closestIndex !== activeIndex) {
          // æ›´æ–° active ä½†ä¸è¦å†è§¸ç™¼ scrollIntoViewï¼Œé¿å…äº’ç›¸å¹²æ“¾
          scrollToIndex(closestIndex, false);
        }
      });
    });

    // åˆå§‹åŒ–
    scrollToIndex(0);
  }

  // ===== Popup è¦–çª—é‚è¼¯ =====
  const modal = document.getElementById("footprint-modal");
  const modalCard = document.getElementById("footprint-modal-card");
  const modalCloseBtn = document.getElementById("footprint-modal-close");
  const modalTitle = document.getElementById("footprint-modal-title");
  const modalPeriod = document.getElementById("footprint-modal-period");
  const modalDesc = document.getElementById("footprint-modal-desc");
  const modalImage = document.getElementById("footprint-modal-image");
  const modalCounter = document.getElementById("footprint-modal-image-counter");
  const modalPrev = document.getElementById("footprint-modal-image-prev");
  const modalNext = document.getElementById("footprint-modal-image-next");

  let modalImages = [];
  let modalImageIndex = 0;

  function updateModalImage() {
    if (!modalImages.length) {
      modalImage.src = "";
      modalImage.alt = "";
      modalCounter.textContent = "";
      modalPrev.disabled = true;
      modalNext.disabled = true;
      return;
    }

    modalImageIndex =
      ((modalImageIndex % modalImages.length) + modalImages.length) %
      modalImages.length;

    modalImage.src = modalImages[modalImageIndex];
    modalImage.alt =
      (modalTitle.textContent || "èª²ç¨‹ç…§ç‰‡") +
      " åœ–ç‰‡ " +
      (modalImageIndex + 1);
    modalCounter.textContent =
      modalImages.length > 1
        ? `${modalImageIndex + 1} / ${modalImages.length}`
        : "1 / 1";

    const disabled = modalImages.length <= 1;
    modalPrev.disabled = disabled;
    modalNext.disabled = disabled;
  }

  // â­ æ¯æ¬¡é–‹å•Ÿ popup æ™‚è·‘ä¸€æ¬¡æµ®å‡ºå‹•ç•«
  function runModalAnimation() {
    if (!modalCard) return;
    modalCard.classList.remove("modal-pop-enter");
    // å¼·åˆ¶é‡ç®—ä¸€æ¬¡ layoutï¼Œè®“å‹•ç•«å¯ä»¥é‡æ–°è§¸ç™¼
    void modalCard.offsetWidth;
    modalCard.classList.add("modal-pop-enter");
  }

  function openModal() {
    if (!modal) return;

    // å…ˆé¡¯ç¤º
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    document.body.classList.add("overflow-hidden");

    // ç§»é™¤é€€å‡ºå‹•ç•«ï¼Œé‡æ–°åŠ å…¥é€²å ´å‹•ç•«
    modalCard.classList.remove("modal-pop-exit");
    void modalCard.offsetWidth; // é‡æ–°è¨ˆç®— layoutï¼Œè®“å‹•ç•«å¯ä»¥å†æ¬¡è§¸ç™¼
    modalCard.classList.add("modal-pop-enter");
  }

  function closeModal() {
    if (!modal) return;

    // é—œé–‰å‰å…ˆæ’­æ”¾æ·¡å‡ºå‹•ç•«
    modalCard.classList.remove("modal-pop-enter");
    modalCard.classList.add("modal-pop-exit");

    // ç­‰å‹•ç•«æ’­å®Œå†çœŸæ­£éš±è—ï¼ˆ0.25 ç§’ï¼‰
    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.body.classList.remove("overflow-hidden");
    }, 250);
  }

  document.querySelectorAll(".timeline-more-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const { title, date, desc, images } = btn.dataset;

      modalTitle.textContent = title || "";
      modalPeriod.textContent = date || "";
      modalDesc.textContent = desc || "";

      modalImages = (images || "")
        .split("|")
        .map((s) => s.trim())
        .filter(Boolean);
      modalImageIndex = 0;
      updateModalImage();
      openModal();
    });
  });

  if (modalCloseBtn) {
    modalCloseBtn.addEventListener("click", closeModal);
  }

  if (modal) {
    // é»èƒŒæ™¯é—œé–‰
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
  }

  if (modalPrev) {
    modalPrev.addEventListener("click", () => {
      if (!modalImages.length) return;
      modalImageIndex -= 1;
      updateModalImage();
    });
  }

  if (modalNext) {
    modalNext.addEventListener("click", () => {
      if (!modalImages.length) return;
      modalImageIndex += 1;
      updateModalImage();
    });
  }

  // ESC é—œé–‰
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal && !modal.classList.contains("hidden")) {
      closeModal();
    }
  });
</script>
